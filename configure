#!/bin/sh -e

defaultPlatform="linux"

function showUsage() {
	msg="$1"

	if [ ! -z "$msg" ]; then
		echo -e "$msg\n"
	fi

	echo "Usage: $0 [<option(s)...>]"
	echo "Options:"
	echo "  -p --platform <platform> Configure for <platform> (default: $defaultPlatform)"
	echo "  -h --help                Show this message"
	echo -e "Supported platforms: \"linux\"\n"

	if [ -z "$msg" ]; then
		exit 0
	else
		exit 1
	fi
}

selectPlatform=0

for arg in $@; do
	if [ $selectPlatform -eq 1 ]; then
		platform="$arg"
		selectPlatform=0

		continue
	fi

	case "$arg" in
	"-p" | "--platform")
		selectPlatform=1
		;;
	"-h" | "--help")
		showUsage
		;;
	*)
		showUsage "Unknown option \"$arg\"."
		;;
	esac
done

if [ -z "$platform" ]; then
	platform="$defaultPlatform"
fi

case "$platform" in
"linux")
	echo "Configuring for platform \"$platform\"..."
	git submodule init
	git submodule update
	cd etcpak
	git submodule init
	git submodule update
	git checkout master
	git branch -D library 2>/dev/null || true
	git checkout -b library
	cp -v ../etcpak.h .
	git add etcpak.h
	sed -i 's|^#include <future>$|#include "etcpak.h"\n\n#include <future>|;s|^int main( int argc, char\*\* argv )$|extern "C" int etcpak(int argc, char*argv[])|' Application.cpp
	cd unix
	sed -i 's|+=$|+= -fPIC|;s|\-lpthread$|-lpthread -shared|;s|etcpak$|libetcpak.so|' build.mk
	sed -i 's|^all: debug$|all: release\n\tstrip -s libetcpak.so|' Makefile
	cd ..
	sed -i 's|etcpak$|libetcpak.so|' .gitignore
	git commit -am "Update to build as library"
	cd ..
	echo "include $platform.mk" >>Makefile
	;;
*)
	showUsage "Unknown platform \"$platform\"."
	;;
esac

echo "Done, you can run \"make\" now."
